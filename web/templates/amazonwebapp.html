<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.fname}} - TouchCalc Spreadsheet</title>
    
    <!-- SocialCalc CSS -->
    <link rel="stylesheet" href="/static/socialcalc.css">
    <link rel="stylesheet" href="/static/screen.css">
    <link rel="stylesheet" href="/static/fonts.css">
    
    <!-- Core JavaScript Libraries -->
    <script src="/static/jquery.min.js"></script>
    <script src="/static/json2.js"></script>
    
    <!-- SocialCalc Core -->
    <script src="/static/socialcalcconstants.js"></script>
    <script src="/static/socialcalc-3.js"></script>
    <script src="/static/socialcalcpopup.js"></script>
    <script src="/static/socialcalctableeditor.js"></script>
    <script src="/static/socialcalcspreadsheetcontrol.js"></script>
    
    <!-- SocialCalc Workbook -->
    <script src="/static/socialcalcworkbook.js"></script>
    <script src="/static/socialcalcworkbookcontrol.js"></script>
    
    <!-- Touch Support -->
    <script src="/static/socialcalctouch.js"></script>
    
    <!-- Charting -->
    <script src="/static/socialcalcgraph.js"></script>
    <script src="/static/Highcharts-2/js/highcharts.js"></script>
    <script src="/static/jquery.flot.js"></script>
    <script src="/static/jquery.sparkline.min.js"></script>
    
    <!-- Formula Support -->
    <script src="/static/formula1.js"></script>
    <script src="/static/formatnumber2.js"></script>
    
    <!-- Auto-save -->
    <script src="/static/autosave.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 24px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .toolbar { background: white; border-bottom: 1px solid #ddd; padding: 10px 20px; display: flex; gap: 10px; align-items: center; }
        .btn { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #f8f9fa; }
        .btn.primary { background: #3498db; color: white; border-color: #3498db; }
        .spreadsheet-container { height: calc(100vh - 120px); background: white; position: relative; }
        #socialcalc-workbook { width: 100%; height: 100%; }
        .status-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #34495e; color: white; padding: 5px 20px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä TouchCalc - {{.fname}}</h1>
        <div class="user-info">
            <span>üë§ {{.user}}</span>
            <span>üíæ Storage: {{.storage}}</span>
            <a href="/browser" class="btn">‚Üê Back to Home</a>
        </div>
    </div>

    <div class="toolbar">
        <button class="btn primary" onclick="saveSpreadsheet()">üíæ Save</button>
        <button class="btn" onclick="loadSpreadsheet()">üìÇ Load</button>
        <button class="btn" onclick="exportCSV()">üìÑ Export CSV</button>
        <button class="btn" onclick="exportExcel()">üìä Export Excel</button>
        <button class="btn" onclick="showImport()">üì• Import</button>
        <button class="btn" onclick="addChart()">üìà Add Chart</button>
        <span id="autosave-status" style="margin-left: auto; color: #666; font-size: 12px;">Ready</span>
    </div>

    <div class="spreadsheet-container">
        <div id="socialcalc-workbook"></div>
    </div>

    <div class="status-bar">
        <span id="status-text">Ready | Storage Backend: {{.storage}}</span>
    </div>

    <!-- Hidden Data -->
    <script>
        window.SPREADSHEET_CONFIG = {
            fname: '{{.fname}}',
            user: '{{.user}}',
            storage: '{{.storage}}',
            sheets: [{{range $index, $sheet := .sheets}}"{{$sheet}}"{{if ne $index (len $.sheets | add -1)}},{{end}}{{end}}],
            apiBase: '/iwebapp'
        };
    </script>

    <!-- SocialCalc Integration Script -->
    <script>
        let spreadsheetControl;
        let currentSheet = 'Sheet1';
        let isDirty = false;
        let autoSaveInterval;

        // Initialize SocialCalc Workbook
        function initializeSocialCalc() {
            try {
                // Create workbook control
                const workbookDiv = document.getElementById('socialcalc-workbook');
                
                // Initialize SocialCalc Workbook Control
                const wbc = new SocialCalc.WorkBookControl();
                wbc.InitializeWorkBookControl(workbookDiv, 0, 0, 0);
                
                // Load initial data if available
                loadInitialData(wbc);
                
                // Setup event handlers
                setupEventHandlers(wbc);
                
                // Start auto-save
                startAutoSave();
                
                spreadsheetControl = wbc;
                updateStatus('TouchCalc spreadsheet loaded successfully');
                
            } catch (error) {
                console.error('Failed to initialize SocialCalc:', error);
                updateStatus('Error: Failed to load spreadsheet');
                alert('Failed to initialize spreadsheet: ' + error.message);
            }
        }

        function loadInitialData(wbc) {
            // Load existing sheet data from server
            const sheetName = window.SPREADSHEET_CONFIG.fname;
            
            // Try to load existing data
            fetch('/iwebapp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    action: 'getfile',
                    appname: 'touchcalc',
                    fname: sheetName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'ok' && data.data) {
                    try {
                        // Parse SocialCalc format data
                        const sheet = wbc.workbook.sheets[0] || wbc.workbook.CreateSheet();
                        sheet.ParseSheetSave(data.data);
                        wbc.RequestRedisplay();
                        updateStatus('Loaded existing spreadsheet data');
                    } catch (error) {
                        console.error('Error parsing sheet data:', error);
                        loadDefaultData(wbc);
                    }
                } else {
                    loadDefaultData(wbc);
                }
            })
            .catch(error => {
                console.error('Error loading sheet:', error);
                loadDefaultData(wbc);
            });
        }

        function loadDefaultData(wbc) {
            // Load default TouchCalc data from touchcalc.msc.txt
            const defaultData = `A1:TouchCalc Spreadsheet
B1:Welcome to your cloud spreadsheet!
A2:Cell A2
B2:Cell B2
C2:=A2+B2
A3:Data automatically saves to the cloud
B3:Storage Backend:
C3:${window.SPREADSHEET_CONFIG.storage}`;

            try {
                const sheet = wbc.workbook.sheets[0] || wbc.workbook.CreateSheet();
                
                // Parse simple format into SocialCalc format
                const lines = defaultData.split('\n');
                lines.forEach(line => {
                    const [coord, value] = line.split(':');
                    if (coord && value) {
                        const cell = sheet.GetAssuredCell(coord);
                        if (value.startsWith('=')) {
                            cell.formula = value.substring(1);
                            cell.datatype = 'f';
                        } else {
                            cell.datavalue = value;
                            cell.datatype = 't';
                        }
                    }
                });
                
                wbc.RequestRedisplay();
                updateStatus('Loaded default TouchCalc template');
            } catch (error) {
                console.error('Error loading default data:', error);
                updateStatus('Error loading default data');
            }
        }

        function setupEventHandlers(wbc) {
            // Track changes
            const originalExecuteCommand = wbc.workbook.sheets[0].ExecuteCommand;
            wbc.workbook.sheets[0].ExecuteCommand = function(cmd, saveundo) {
                const result = originalExecuteCommand.call(this, cmd, saveundo);
                if (saveundo && cmd !== 'redisplay') {
                    isDirty = true;
                    updateStatus('Modified - auto-save in 30 seconds');
                }
                return result;
            };
        }

        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                if (isDirty) {
                    saveSpreadsheet(true); // Silent save
                }
            }, 30000); // Auto-save every 30 seconds
        }

        function saveSpreadsheet(silent = false) {
            if (!spreadsheetControl || !spreadsheetControl.workbook.sheets[0]) {
                if (!silent) alert('No spreadsheet to save');
                return;
            }

            try {
                const sheet = spreadsheetControl.workbook.sheets[0];
                const sheetData = sheet.CreateSheetSave();
                
                const formData = new URLSearchParams({
                    action: 'savefile',
                    appname: 'touchcalc',
                    fname: window.SPREADSHEET_CONFIG.fname,
                    data: sheetData
                });

                updateStatus('Saving...');
                
                fetch('/iwebapp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'ok') {
                        isDirty = false;
                        updateStatus('Saved successfully');
                        if (!silent) alert('Spreadsheet saved successfully!');
                    } else {
                        throw new Error(data.data || 'Save failed');
                    }
                })
                .catch(error => {
                    console.error('Save error:', error);
                    updateStatus('Save failed: ' + error.message);
                    if (!silent) alert('Save failed: ' + error.message);
                });
                
            } catch (error) {
                console.error('Save error:', error);
                updateStatus('Save error: ' + error.message);
                if (!silent) alert('Save error: ' + error.message);
            }
        }

        function loadSpreadsheet() {
            const filename = prompt('Enter filename to load:', window.SPREADSHEET_CONFIG.fname);
            if (!filename) return;

            fetch('/iwebapp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    action: 'getfile',
                    appname: 'touchcalc',
                    fname: filename
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'ok' && data.data) {
                    const sheet = spreadsheetControl.workbook.sheets[0];
                    sheet.ParseSheetSave(data.data);
                    spreadsheetControl.RequestRedisplay();
                    updateStatus('Loaded: ' + filename);
                    alert('Loaded successfully!');
                } else {
                    throw new Error('File not found or load failed');
                }
            })
            .catch(error => {
                console.error('Load error:', error);
                alert('Load failed: ' + error.message);
            });
        }

        function exportCSV() {
            if (!spreadsheetControl?.workbook.sheets[0]) return;
            
            const sheet = spreadsheetControl.workbook.sheets[0];
            const csvData = SocialCalc.ConvertSaveToOtherFormat(sheet.CreateSheetSave(), 'csv');
            
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = window.SPREADSHEET_CONFIG.fname + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportExcel() {
            alert('Excel export - Coming soon!');
        }

        function showImport() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvData = e.target.result;
                        const socialCalcData = SocialCalc.ConvertOtherFormatToSave(csvData, 'csv');
                        
                        const sheet = spreadsheetControl.workbook.sheets[0];
                        sheet.ParseSheetSave(socialCalcData);
                        spreadsheetControl.RequestRedisplay();
                        
                        updateStatus('Import successful');
                        alert('File imported successfully!');
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('Import failed: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function addChart() {
            alert('Chart functionality - Coming soon!');
        }

        function updateStatus(message) {
            document.getElementById('status-text').textContent = message + ' | Storage: ' + window.SPREADSHEET_CONFIG.storage;
            document.getElementById('autosave-status').textContent = message;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure all scripts are loaded
            setTimeout(initializeSocialCalc, 100);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function(e) {
            if (isDirty) {
                e.preventDefault();
                e.returnValue = '';
                return 'You have unsaved changes. Are you sure you want to leave?';
            }
            
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
        });
    </script>
</body>
</html>